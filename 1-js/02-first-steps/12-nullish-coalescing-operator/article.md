# Оператор нулевого слияния (??)

[recent browser="new"]

Оператор нулевого слияния представляет собой два вопросительных знака `??`.

Так как он рассматривает `null` и `undefined` аналогично, мы введём специальный термин. Мы будем говорить, что выражение "определено", только если оно не равняется ни `null`, ни `undefined`.

Результат выражения `a ?? b` будет следующим:
- `a`, если значение `a` определено,
- `b`, если значение `a` не определено.

То есть оператор `??` возвращает первый аргумент, если он не `null/undefined`, иначе второй.

Оператор нулевого слияния не является чем-то принципиально новым. Это всего лишь удобный синтаксис, как из двух значений получить одно "определённое".

Вот как можно переписать выражение `result = a ?? b`, используя уже знакомые нам операторы:

```js
result = (a !== null && a !== undefined) ? a : b;
```

Теперь должно быть абсолютно ясно, что `??` делает. Давайте посмотрим, где это может быть полезно.

Как правило, оператор `??` нужен для того, чтобы задать значение по умолчанию для потенциально неопределённой переменной.

Например, здесь мы отобразим `user`, если он определен, в противном случае `Аноним`:

```js run
let user;

alert(user ?? "Аноним"); // Аноним (user не определен)
```

Вот пример `user`, с присвоенным именем:

```js run
let user = "Иван";

alert(user ?? "Аноним"); // Иван (user определен)
```

Кроме этого, можно записать последовательность из операторов `??`, чтобы получить первое значение из списка, которое не является `null/undefined`.

Допустим, у нас есть данные пользователя в переменных `firstName`, `lastName` или `nickName`. Все они могут быть не определены, если пользователь решил не вводить значение.

Мы хотели бы отобразить имя пользователя, используя одну из этих переменных, или показать "Анонимный", если все они не определены.

Для этого воспользуемся оператором `??`:

```js run
let firstName = null;
let lastName = null;
let nickName = "Суперкодер";

// показывает первое определённое значение:
*!*
alert(firstName ?? lastName ?? nickName ?? "Аноним"); // Суперкодер
*/!*
```

## Сравнение с ||

Оператор ИЛИ `||` можно использовать для того же, что и `??`, как это было показано в [предыдущей главе](info:logical-operators#or-finds-the-first-truthy-value).

Например, если в приведённом выше коде заменить `??` на `||`, то будет тот же самый результат:

```js run
let firstName = null;
let lastName = null;
let nickName = "Суперкодер";

// показывает первое истинное значение:
*!*
alert(firstName || lastName || nickName || "Аноним"); // Суперкодер
*/!*
```

Исторически сложилось так, что оператор ИЛИ `||` появился первым. Он существует с самого начала существования JavaScript, поэтому разработчики долгое время использовали его для таких целей.

С другой стороны, сравнительно недавно в язык был добавлен оператор нулевого слияния `??` как раз потому, что многие были недовольны оператором `||`.

Важное различие между ними заключается в том, что:
- `||` возвращает первое *истинное* значение.
- `??` возвращает первое *определённое* значение.

Проще говоря, оператор `||` не различает `false`, `0`, пустую строку `""` и `null/undefined`. Для него они все одинаковые, т.е. являются ложными значениями. Если первым аргументом для оператора `||` будет любое из перечисленных значений, то в качестве результата мы получим второй аргумент.

Однако на практике часто требуется использовать значение по умолчанию только тогда, когда переменная является `null/undefined`. Ведь именно тогда значение действительно неизвестно/не определено.

Например, рассмотрим следующий пример:

```js run
let height = 0;

alert(height || 100); // 100
alert(height ?? 100); // 0
```

- `height || 100` проверяет `height` на наличие ложного значения, оно равно `0`, так что это действительно false.
    - поэтому результатом `||` является второй аргумент, т.е. `100`.
- `height ?? 100` проверяет, что переменная `height` содержит `null/undefined`, а поскольку это не так,
    - то результатом является сама переменная `height`, т.е. `0`.

На практике нулевая высота часто является вполне возможным значением, которое не следует заменять значением по умолчанию. Таким образом, `??` делает все правильно.

## Приоритет

Приоритет оператора `??` такой же, как и у `||`. Они оба равны `4` в [таблице на MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table).

Это означает, что, как и `||`, оператор нулевого слияния `??` вычисляется до `=` и `?`, но после большинства других операций, таких как `+`, `*`.

Из этого следует, что если нужно выбрать значение при помощи оператора `??` вместе с другими операторами в выражении, следует добавить круглые скобки:

```js run
let height = null;
let width = null;

// важно: используйте круглые скобки
let area = (height ?? 100) * (width ?? 50);

alert(area); // 5000
```

Иначе, если опустить скобки, то оператор `*` выполнится первым, так как у него приоритет выше, чем у `??`, а это приведёт к неправильным результатам.

```js
// без круглых скобок
let area = height ?? 100 * width ?? 50;

// ...то же самое, что предыдущее выражение (вероятно, это не то, что нам нужно):
let area = height ?? (100 * width) ?? 50;
```

### Использование ?? вместе с && или ||

По соображениям безопасности JavaScript запрещает использование оператора `??` вместе с `&&` и `||`, если только приоритет явно не указан в круглых скобках.

Выполнение следующего кода приведёт к синтаксической ошибке:

```js run
let x = 1 && 2 ?? 3; // Синтаксическая ошибка
```

Ограничение безусловно спорное, оно было добавлено в спецификацию языка с целью избежать ошибок программирования, когда люди начнут переключаться с `||` на `??`.

Используйте круглые скобки, чтобы обойти это ограничение: 

```js run
*!*
let x = (1 && 2) ?? 3; // Работает без ошибок
*/!*

alert(x); // 2
```

## Итого

- Оператор нулевого слияния `??` — это быстрый способ выбрать первое "определённое" значение из списка.

    Используется для присвоения переменным значений по умолчанию:

    ```js
    // будет height=100, если переменная height равна null или undefined
    height = height ?? 100;
    ```

- Оператор `??` имеет очень низкий приоритет, лишь немного выше, чем у `?` и `=`, поэтому при использовании его в выражении, скорее всего, потребуются скобки.
- Запрещено использовать вместе с `||` или `&&` без явно указанных круглых скобок.
